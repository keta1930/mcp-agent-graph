"""
系统工具：get_prompt_spec
获取 Prompt 创建规范文档
"""
import logging
from typing import Dict, Any

logger = logging.getLogger(__name__)

# 工具 Schema（OpenAI format）
TOOL_SCHEMA = {
    "type": "function",
    "function": {
        "name": "get_prompt_spec",
        "description": "获取Prompt创建规范文档。此文档包含如何设计和创建Prompt的完整指南。可以参考此规范来创建新的Prompt模板。",
        "parameters": {
            "type": "object",
            "properties": {},
            "required": []
        }
    }
}


async def handler(user_id: str, **kwargs) -> Dict[str, Any]:
    """
    获取 Prompt 创建规范文档

    Args:
        user_id: 用户ID
        **kwargs: 其他参数

    Returns:
        {
            "success": True,
            "spec": "规范文档内容...",
            "message": "成功获取Prompt创建规范"
        }
    """
    try:
        # 获取所有已有的提示词，提取分类
        from app.services.prompt.prompt_service import prompt_service
        
        result = await prompt_service.list_prompts(user_id)
        categories = set()
        
        if result.get("success") and result.get("data"):
            prompts = result["data"].get("prompts", [])
            for prompt in prompts:
                if isinstance(prompt, dict) and prompt.get("category"):
                    categories.add(prompt["category"])
        
        # 将分类列表格式化为字符串
        if categories:
            categories_str = ", ".join([f'"{cat}"' for cat in sorted(categories)])
        else:
            categories_str = "暂无分类"
        
        # 替换占位符
        spec_content = _PROMPT_SPEC.replace("{{categories}}", categories_str)
        
        return {
            "success": True,
            "spec": spec_content,
            "message": f"成功获取Prompt创建规范，系统中已有 {len(categories)} 个分类"
        }

    except Exception as e:
        logger.error(f"get_prompt_spec 执行失败: {str(e)}")
        return {
            "success": False,
            "message": f"获取Prompt创建规范失败：{str(e)}",
            "spec": None
        }

_PROMPT_SPEC = '''
# 高质量提示词编写规范

## 概述

你是一个专业的提示词工程师，擅长通过深入理解用户意图，创建结构化、可复用、高质量的提示词。本规范指导你如何编写优秀的提示词模板。

**工具使用说明：** 此工具需结合 `create_file` 工具使用，创建 Markdown 文件，并在文件中为用户创建提示词。使用 `register_prompt` 工具注册提示词到系统。

**系统中已有的提示词类别：** {{categories}}

## 提示词设计原则

### 1. 深入理解用户意图
在编写提示词之前，必须充分理解：
- **使用场景**：提示词将在什么情况下使用？
- **目标受众**：谁会使用这个提示词？
- **预期输出**：用户期望得到什么样的结果？
- **约束条件**：有哪些限制或特殊要求？

### 2. 结构化设计
优秀的提示词应该具有清晰的结构：

**基础结构模板：**
```
[角色定义]
你是一个...

[任务描述]
你的任务是...

[具体要求]
1. 要求一
2. 要求二
3. 要求三

[输出格式]
请按照以下格式输出...

[注意事项]
- 注意点一
- 注意点二
```

### 3. 可复用性
设计提示词时考虑：
- **通用性**：避免过于具体的场景限制
- **灵活性**：可以适应不同的输入和需求
- **模块化**：可以与其他提示词组合使用

### 4. 清晰明确
- 使用简洁、准确的语言
- 避免歧义和模糊表达
- 明确指出期望的行为和输出

### 5. 分层次组织
- 使用 Markdown 标题组织内容层次
- 使用列表展示多个要点
- 使用代码块展示格式示例

## 提示词编写模式

### 模式 1：角色扮演型
适用于需要特定专业视角的场景。

**结构：**
```
你是一个[专业角色]，具有[专业能力]。

你的职责是[具体职责]。

在执行任务时，你需要：
1. [行为准则1]
2. [行为准则2]
3. [行为准则3]
```

**示例：**
```
你是一个资深的代码审查专家，具有10年以上的软件开发经验。

你的职责是对代码进行全面、专业的审查，发现潜在问题并提供改进建议。

在审查代码时，你需要：
1. 评估代码的可读性和可维护性
2. 识别性能瓶颈和优化机会
3. 检查安全漏洞和潜在风险
4. 确保代码遵循最佳实践和编码规范
```

### 模式 2：任务导向型
适用于明确的任务执行场景。

**结构：**
```
请完成以下任务：[任务描述]

任务要求：
1. [要求1]
2. [要求2]
3. [要求3]

输出格式：
[格式说明]
```

**示例：**
```
请对提供的数据进行深入分析。

分析要求：
1. 识别数据的主要特征和分布模式
2. 计算关键统计指标（均值、中位数、标准差等）
3. 发现数据中的异常值和趋势
4. 提供基于数据的洞察和建议

输出格式：
- 数据概览（200字以内）
- 关键指标表格
- 趋势分析（300字以内）
- 结论和建议（200字以内）
```

### 模式 3：步骤引导型
适用于需要按步骤执行的复杂任务。

**结构：**
```
请按照以下步骤完成任务：

步骤1：[步骤描述]
- [具体要求]

步骤2：[步骤描述]
- [具体要求]

步骤3：[步骤描述]
- [具体要求]

最终输出：
[输出要求]
```

**示例：**
```
请按照以下步骤撰写技术文档：

步骤1：理解技术内容
- 仔细阅读提供的技术资料
- 识别核心概念和关键技术点

步骤2：组织文档结构
- 设计清晰的章节层次
- 确定每个章节的核心内容

步骤3：编写文档内容
- 使用简洁准确的技术语言
- 提供代码示例和图表说明
- 添加必要的注释和说明

步骤4：审查和优化
- 检查技术准确性
- 确保逻辑连贯性
- 优化可读性

最终输出：
完整的技术文档，包含目录、正文、代码示例和总结。
```

### 模式 4：约束条件型
适用于有明确限制和规范的场景。

**结构：**
```
[任务描述]

必须遵守的约束：
1. [约束1]
2. [约束2]
3. [约束3]

禁止的行为：
- [禁止项1]
- [禁止项2]

输出要求：
[具体要求]
```

**示例：**
```
请生成一篇面向儿童的科普文章。

必须遵守的约束：
1. 使用简单易懂的语言，避免专业术语
2. 文章长度控制在500-800字
3. 包含至少2个生动的比喻或例子
4. 语气轻松活泼，富有趣味性

禁止的行为：
- 使用复杂的科学术语
- 内容过于抽象难懂
- 语气严肃刻板

输出要求：
包含标题、引言、正文（2-3个段落）和结尾的完整文章。
```

## 提示词质量检查清单

在完成提示词编写后，检查以下要点：

### 内容完整性
- [ ] 是否明确定义了角色或任务？
- [ ] 是否清楚说明了期望的输出？
- [ ] 是否包含必要的约束和要求？
- [ ] 是否提供了足够的上下文信息？

### 结构清晰性
- [ ] 是否使用了清晰的层次结构？
- [ ] 是否使用了列表、标题等格式化元素？
- [ ] 是否易于阅读和理解？

### 可复用性
- [ ] 是否具有通用性，可以应用于多个场景？
- [ ] 是否避免了过于具体的限制？
- [ ] 是否可以与其他提示词组合使用？

### 语言质量
- [ ] 是否使用了清晰、准确的语言？
- [ ] 是否避免了歧义和模糊表达？
- [ ] 是否语法正确、表达流畅？

## 常见场景示例

### 代码相关
- 代码审查、代码生成、代码优化、代码解释、调试辅助

### 写作相关
- 文章撰写、内容改写、摘要生成、标题优化、风格转换

### 分析相关
- 数据分析、文本分析、趋势预测、问题诊断、方案评估

### 创意相关
- 头脑风暴、创意生成、故事创作、设计建议、命名建议

### 教育相关
- 知识讲解、习题生成、学习计划、概念解释、案例分析

## 最佳实践

1. **先问后写**：在编写提示词前，充分了解用户的具体需求和使用场景
2. **迭代优化**：根据实际使用效果不断优化提示词
3. **保持简洁**：避免冗余信息，每句话都应有明确目的
4. **提供示例**：在提示词中包含输入输出示例，帮助理解预期效果
5. **考虑边界**：明确提示词的适用范围和限制条件
6. **使用 Markdown**：充分利用 Markdown 格式提升可读性

## 命名和分类建议

### 命名规范
- 使用描述性的英文名称
- 使用下划线分隔单词：`code_review`、`data_analysis`
- 避免特殊字符：`/ \ : * ? " < > |`

### 分类建议
- `coding` - 代码相关
- `writing` - 写作相关
- `analysis` - 分析相关
- `creative` - 创意相关
- `education` - 教育相关
- `research` - 研究相关
- `business` - 商业相关
- `general` - 通用场景
'''
