<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图管理 - MAG SDK</title>

    <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link id="highlight-theme" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" rel="stylesheet">
    <link href="./shared.css" rel="stylesheet">

</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">
            <i class="fas fa-project-diagram mr-3 text-blue-600"></i>图管理
        </h1>

        <p class="text-lg mb-8" style="color: var(--text-muted)">
            MAG SDK 的图管理功能让您可以创建、运行和管理复杂的智能体工作流。支持AI生成图配置、流式执行和导入导出等功能。
        </p>

        <!-- 基本图操作 -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-list mr-2 text-green-600"></i>基本图操作
            </h2>

            <h3 class="text-xl font-medium mb-3">列出所有图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def list_graph() -> List[str]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 获取所有图列表
graphs = mag.list_graph()
print("可用的图:")
for graph in graphs:
    print(f"- {graph}")</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">获取图配置</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def get_graph_config(graph_name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 获取指定图的配置
config = mag.get_graph_config("research_workflow")
print("图配置:", config)

# 查看图的节点信息
nodes = config.get("nodes", {})
for node_id, node_info in nodes.items():
    print(f"节点 {node_id}: {node_info.get('name', 'Unnamed')}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">获取图详细信息</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def get_graph_detail(graph_name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 获取图的详细信息（包括README）
detail = mag.get_graph_detail("research_workflow")
print(f"图名称: {detail['name']}")
print(f"配置: {detail['config']}")
print(f"说明文档: {detail['readme']}")
</code></pre>
            </div>
        </div>

        <!-- 图运行 -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-play mr-2 text-blue-600"></i>图运行
            </h2>

            <p class="mb-4" style="color: var(--text-secondary)">
                <code>run_graph</code> 支持三种运行模式：后台运行、前台流式和前台非流式。
            </p>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def run_graph(name: str, input_text: str, stream: bool = False, background: bool = False)
    -> Union[Dict[str, Any], Iterator[Dict[str, Any]], str]</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">后台运行模式</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 后台运行图，立即返回conversation_id
conversation_id = mag.run_graph(
    name="research_workflow",
    input_text="研究人工智能的最新发展",
    background=True
)

print(f"图在后台运行中，对话ID: {conversation_id}")

# 可以稍后查看结果
# result = mag.get_conversation_detail(conversation_id)</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">前台流式模式</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 流式执行图，实时接收数据
for chunk in mag.run_graph(
    name="research_workflow",
    input_text="分析当前AI技术趋势",
    stream=True
):
    if chunk.get("type") == "node_start":
        print(f"\n开始执行节点: {chunk.get('node_name')}")
    elif chunk.get("type") == "node_complete":
        print(f"完成节点: {chunk.get('node_name')}")
    elif chunk.get("type") == "content":
        print(chunk.get("content", ""), end="")
    elif chunk.get("type") == "graph_complete":
        print("\n图执行完成!")
        break</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">前台非流式模式</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 等待图执行完成后返回完整结果
result = mag.run_graph(
    name="research_workflow",
    input_text="总结人工智能发展历程",
    stream=False,
    background=False
)

print("图执行结果:")
print(f"对话ID: {result['_id']}")
print(f"执行轮次: {len(result['rounds'])}")

# 查看最后一轮的结果
if result['rounds']:
    last_round = result['rounds'][-1]
    print(f"最终输出: {last_round.get('content', 'No content')}")
</code></pre>
            </div>
        </div>

        <!-- AI图生成 -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-magic mr-2 text-purple-600"></i>AI图生成与优化
            </h2>

            <h3 class="text-xl font-medium mb-3">生成新图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def gen_graph(requirement: str, model_name: str, mcp_servers: List[str] = None,
             conversation_id: Optional[str] = None, user_id: str = "default_user",
             stream: bool = False) -> Union[Dict[str, Any], Iterator[Dict[str, Any]]]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 生成新的图配置
requirement = """
创建一个新闻分析工作流：
1. 搜索相关新闻
2. 提取关键信息
3. 进行情感分析
4. 生成摘要报告
"""

result = mag.gen_graph(
    requirement=requirement,
    model_name="gpt-4",
    mcp_servers=["brave-search", "filesystem"],
    conversation_id="news_analysis_gen",
    stream=False
)

print(f"图生成状态: {result['status']}")
print(f"生成的图名称: {result['graph_name']}")
print(f"分析结果: {result['analysis']}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">优化现有图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def update_graph(graph_name: str, optimization_requirement: str, model_name: str,
                mcp_servers: List[str] = None, conversation_id: Optional[str] = None,
                user_id: str = "default_user", stream: bool = False) -> Union[Dict[str, Any], Iterator[Dict[str, Any]]]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 优化现有图
optimization = """
优化新闻分析工作流：
1. 增加多语言支持
2. 添加图表生成功能
3. 改进错误处理机制
"""

result = mag.update_graph(
    graph_name="news_analysis",
    optimization_requirement=optimization,
    model_name="gpt-4",
    mcp_servers=["filesystem"],
    conversation_id="news_optimize_001"
)

print(f"优化状态: {result['status']}")
print(f"优化后的图名称: {result['graph_name']}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">获取生成提示词</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def graph_gen_prompt(mcp_servers: List[str] = None) -> str</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 获取图生成的提示词模板
prompt = mag.graph_gen_prompt(mcp_servers=["filesystem", "brave-search"])
print("图生成提示词模板:")
print(prompt)
</code></pre>
            </div>
        </div>

        <!-- 图管理 -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-cogs mr-2 text-orange-600"></i>图管理操作
            </h2>

            <h3 class="text-xl font-medium mb-3">保存图配置</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def save_graph(config: Dict[str, Any]) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 创建图配置
graph_config = {
    "name": "simple_chat",
    "description": "简单的聊天工作流",
    "nodes": {
        "chat_node": {
            "name": "聊天节点",
            "type": "llm_call",
            "prompt": "你是一个友好的助手，请回答用户的问题：{input}",
            "model": "gpt-4"
        }
    },
    "edges": [],
    "start_node": "chat_node"
}

result = mag.save_graph(graph_config)
print(f"保存结果: {result}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">删除图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def delete_graph(name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 删除指定图
result = mag.delete_graph("old_workflow")
print(f"删除结果: {result}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">重命名图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def rename_graph(old_name: str, new_name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 重命名图
result = mag.rename_graph("old_name", "new_name")
print(f"重命名结果: {result}")
</code></pre>
            </div>
        </div>

        <!-- 导入导出 -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-exchange-alt mr-2 text-indigo-600"></i>导入导出
            </h2>

            <h3 class="text-xl font-medium mb-3">导入图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def import_graph(file_path: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 从JSON文件导入图配置
result = mag.import_graph("/path/to/graph_config.json")
print(f"导入结果: {result}")

# 从ZIP包导入完整图包
result = mag.import_graph("/path/to/graph_package.zip")
print(f"包导入结果: {result}")
</code></pre>
            </div>

            <h3 class="text-xl font-medium mb-3">导出图</h3>
            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def export_graph(name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 导出图为ZIP包
result = mag.export_graph("research_workflow")
print(f"导出结果: {result}")
print(f"导出文件路径: {result['file_path']}")
</code></pre>
            </div>
        </div>

        <!-- 图转MCP -->
        <div class="method-card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-code mr-2 text-red-600"></i>图转MCP
            </h2>

            <p class="mb-4" style="color: var(--text-secondary)">
                将图工作流转换为独立的MCP服务器脚本。
            </p>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">函数签名</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">def graph_to_mcp(name: str) -> Dict[str, Any]</code></pre>
            </div>

            <div class="code-block mb-4">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">使用示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag

# 将图转换为MCP服务器
result = mag.graph_to_mcp("research_workflow")

print(f"转换状态: {result['status']}")
print(f"MCP服务器脚本:\n{result['script']}")

# 如果需要，可以将脚本保存到文件
if result['status'] == 'success':
    with open('research_mcp_server.py', 'w') as f:
        f.write(result['script'])
    print("MCP服务器脚本已保存")
</code></pre>
            </div>
        </div>

        <!-- 完整示例 -->
        <div class="method-card p-6">
            <h2 class="text-2xl font-semibold mb-4">
                <i class="fas fa-code mr-2 text-gray-600"></i>完整示例
            </h2>

            <p class="mb-4" style="color: var(--text-secondary)">
                以下是一个完整的图管理示例，展示了从创建到运行的完整流程：
            </p>

            <div class="code-block">
                <div class="flex justify-between items-center p-3 border-b border-gray-200">
                    <span class="text-sm font-medium text-gray-600">完整示例</span>
                    <button class="copy-btn px-3 py-1 text-xs rounded" onclick="copyCode(this)">复制</button>
                </div>
                <pre class="p-4 overflow-x-auto"><code class="language-python">import mag
import time

# 启动服务
mag.start()

print("=== 图管理完整示例 ===")

# 1. 查看现有图
print("\n1. 现有图列表:")
graphs = mag.list_graph()
for graph in graphs:
    print(f"  - {graph}")

# 2. AI生成新图
print("\n2. AI生成新图:")
requirement = """
创建一个文档分析工作流：
1. 读取文档内容
2. 提取关键信息
3. 生成摘要
4. 保存结果到文件
"""

gen_result = mag.gen_graph(
    requirement=requirement,
    model_name="gpt-4",
    mcp_servers=["filesystem"],
    conversation_id="doc_analysis_gen"
)

if gen_result['status'] == 'success':
    graph_name = gen_result['graph_name']
    print(f"✓ 成功生成图: {graph_name}")

    # 3. 查看生成的图配置
    print(f"\n3. 查看图配置:")
    config = mag.get_graph_config(graph_name)
    print(f"  节点数量: {len(config.get('nodes', {}))}")
    print(f"  连接数量: {len(config.get('edges', []))}")

    # 4. 运行图（流式模式）
    print(f"\n4. 运行图 ({graph_name}):")
    print("流式输出:")

    for chunk in mag.run_graph(
        name=graph_name,
        input_text="分析这段文本：人工智能正在改变世界...",
        stream=True
    ):
        if chunk.get("type") == "node_start":
            print(f"\n[节点开始] {chunk.get('node_name')}")
        elif chunk.get("type") == "node_complete":
            print(f"[节点完成] {chunk.get('node_name')}")
        elif chunk.get("type") == "content":
            print(chunk.get("content", ""), end="")
        elif chunk.get("type") == "graph_complete":
            print("\n[图执行完成]")
            break

    # 5. 后台运行示例
    print(f"\n5. 后台运行示例:")
    conversation_id = mag.run_graph(
        name=graph_name,
        input_text="分析另一个文档...",
        background=True
    )
    print(f"后台任务启动，对话ID: {conversation_id}")

    # 6. 导出图
    print(f"\n6. 导出图:")
    export_result = mag.export_graph(graph_name)
    if export_result.get('status') == 'success':
        print(f"✓ 图已导出到: {export_result['file_path']}")

    # 7. 图转MCP
    print(f"\n7. 图转MCP:")
    mcp_result = mag.graph_to_mcp(graph_name)
    if mcp_result.get('status') == 'success':
        print("✓ 成功生成MCP服务器脚本")
        print(f"脚本长度: {len(mcp_result['script'])} 字符")

    # 8. 优化图
    print(f"\n8. 优化图:")
    optimization = "增加错误处理和日志记录功能"

    optimize_result = mag.update_graph(
        graph_name=graph_name,
        optimization_requirement=optimization,
        model_name="gpt-4",
        conversation_id="doc_optimize_001"
    )

    if optimize_result['status'] == 'success':
        optimized_name = optimize_result['graph_name']
        print(f"✓ 图已优化: {optimized_name}")

else:
    print(f"✗ 图生成失败: {gen_result.get('message', 'Unknown error')}")

print("\n=== 图管理示例完成 ===")
</code></pre>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="./shared.js"></script>
</body>
</html>