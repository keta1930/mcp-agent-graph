# 前端架构

<cite>
**本文档引用文件**  
- [App.tsx](file://frontend/src/App.tsx)
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx)
- [WorkspaceLayout.tsx](file://frontend/src/layouts/WorkspaceLayout.tsx)
- [graphEditorStore.ts](file://frontend/src/store/graphEditorStore.ts)
- [mcpStore.ts](file://frontend/src/store/mcpStore.ts)
- [api.ts](file://frontend/src/services/api.ts)
- [graphService.ts](file://frontend/src/services/graphService.ts)
- [useSSEConnection.ts](file://frontend/src/hooks/useSSEConnection.ts)
- [GraphCanvas.tsx](file://frontend/src/components/graph-editor/GraphCanvas.tsx)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [状态管理方案](#状态管理方案)
6. [服务层与API通信](#服务层与api通信)
7. [实时事件流通信](#实时事件流通信)
8. [前端架构图](#前端架构图)

## 项目结构

前端项目基于React + Vite构建，采用模块化设计，目录结构清晰，职责分明。主要模块包括组件、布局、页面、服务、状态存储、类型定义等。

```mermaid
graph TB
subgraph "前端模块"
A[components] --> |UI组件| B[layouts]
B --> C[pages]
D[store] --> |状态管理| C
E[services] --> |API调用| F[api]
G[hooks] --> |自定义Hook| C
H[types] --> |类型定义| 所有模块
end
```

**图示来源**  
- [frontend/src](file://frontend/src)

## 核心组件

前端应用以`App.tsx`为入口，通过React Router实现路由控制，`MainLayout.tsx`和`WorkspaceLayout.tsx`提供不同层级的布局管理，`GraphCanvas.tsx`基于React Flow实现图可视化编辑。

**本节来源**  
- [App.tsx](file://frontend/src/App.tsx#L1-L67)
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx#L1-L115)
- [WorkspaceLayout.tsx](file://frontend/src/layouts/WorkspaceLayout.tsx#L1-L189)
- [GraphCanvas.tsx](file://frontend/src/components/graph-editor/GraphCanvas.tsx#L1-L744)

## 架构概述

系统采用单页应用架构，通过React Router管理路由，Zustand进行状态管理，Axios封装API调用，SSE实现服务器实时通信。整体架构分为UI层、状态层、服务层和数据层。

```mermaid
graph TD
A[用户界面] --> B[状态管理]
B --> C[服务层]
C --> D[后端API]
D --> E[数据库]
F[SSE连接] --> A
F --> B
```

**图示来源**  
- [App.tsx](file://frontend/src/App.tsx#L1-L67)
- [store](file://frontend/src/store)
- [services](file://frontend/src/services)
- [hooks](file://frontend/src/hooks)

## 详细组件分析

### 主入口App.tsx分析

`App.tsx`作为应用主入口，使用React Router定义路由规则，将不同路径映射到对应页面组件，并通过`WorkspaceLayout`包装工作区子页面，实现统一布局。

```mermaid
graph TD
A[App.tsx] --> B[路由定义]
B --> C[/]
B --> D[/chat]
B --> E[/workspace]
E --> F[/workspace/graph-editor]
E --> G[/workspace/model-manager]
E --> H[/workspace/mcp-manager]
F --> I[GraphEditor]
G --> J[ModelManager]
H --> K[MCPManager]
```

**图示来源**  
- [App.tsx](file://frontend/src/App.tsx#L1-L67)

### 布局管理组件分析

#### MainLayout.tsx布局机制

`MainLayout.tsx`提供顶部导航布局，包含图形编辑器、模型管理、MCP管理等菜单项，以及系统关闭按钮，适用于非工作区页面。

```mermaid
graph TD
A[MainLayout] --> B[顶部导航栏]
B --> C[菜单项]
C --> D[图形编辑器]
C --> E[模型管理]
C --> F[MCP管理]
B --> G[关闭系统按钮]
A --> H[内容区域]
```

**图示来源**  
- [MainLayout.tsx](file://frontend/src/layouts/MainLayout.tsx#L1-L115)

#### WorkspaceLayout.tsx工作区作用

`WorkspaceLayout.tsx`提供侧边栏导航的工作区布局，包含折叠/展开功能、返回首页和关闭系统按钮，专为工作区页面设计。

```mermaid
graph TD
A[WorkspaceLayout] --> B[侧边栏]
B --> C[LOGO]
B --> D[菜单项]
D --> E[图形编辑器]
D --> F[模型管理]
D --> G[MCP管理]
A --> H[主内容区]
H --> I[页眉]
I --> J[折叠按钮]
I --> K[返回首页]
I --> L[关闭系统]
```

**图示来源**  
- [WorkspaceLayout.tsx](file://frontend/src/layouts/WorkspaceLayout.tsx#L1-L189)

## 状态管理方案

采用Zustand实现全局状态集中管理，避免组件层级过深导致的prop drilling问题，支持跨组件状态共享。

### graphEditorStore状态管理

`graphEditorStore.ts`管理图形编辑器的全局状态，包括图列表、当前图、节点选择、脏检查等，提供完整的图操作API。

```mermaid
classDiagram
class useGraphEditorStore {
+graphs : string[]
+currentGraph : GraphConfig | null
+originalGraph : GraphConfig | null
+loading : boolean
+error? : string
+selectedNode : string | null
+dirty : boolean
+fetchGraphs() : Promise~void~
+createNewGraph(name, description) : void
+loadGraph(name) : Promise~void~
+saveGraph() : Promise~void~
+deleteGraph(name) : Promise~void~
+renameGraph(oldName, newName) : Promise~void~
+updateGraphProperties(updates) : void
+addNode(node) : void
+updateNode(id, updates) : void
+removeNode(id) : void
+selectNode(id) : void
+updateNodePosition(id, position) : void
+addConnection(source, target) : void
+removeConnection(source, target) : void
+autoLayout() : void
}
```

**图示来源**  
- [graphEditorStore.ts](file://frontend/src/store/graphEditorStore.ts#L1-L707)

### mcpStore状态管理

`mcpStore.ts`管理MCP配置、状态、工具等全局状态，提供服务器连接、断开、工具注册等操作接口。

```mermaid
classDiagram
class useMCPStore {
+config : MCPConfig
+status : Record~string, any~
+tools : Record~string, any[]~
+loading : boolean
+error? : string
+fetchConfig() : Promise~void~
+updateConfig(config) : Promise~void~
+fetchStatus() : Promise~void~
+connectServer(serverName) : Promise~void~
+disconnectServer(serverName) : Promise~void~
+fetchTools() : Promise~void~
+connectAllServers() : Promise~{ success : string[], failed : string[] }~
+addServer(serverName, serverConfig) : Promise~void~
+updateServer(serverName, serverConfig) : Promise~void~
+deleteServer(serverName) : Promise~void~
+registerMCPTool(toolData) : Promise~void~
+testTool(serverName, toolName, params) : Promise~any~
+getUsedPorts() : number[]
}
```

**图示来源**  
- [mcpStore.ts](file://frontend/src/store/mcpStore.ts#L1-L221)

## 服务层与API通信

### API服务层封装

`api.ts`封装Axios实例，配置基础URL和请求头，为所有API调用提供统一的HTTP客户端。

```mermaid
classDiagram
class api {
-baseURL : string
-headers : object
+get(url, config)
+post(url, data, config)
+put(url, data, config)
+delete(url, config)
}
```

**图示来源**  
- [api.ts](file://frontend/src/services/api.ts#L1-L13)

### graphService API调用逻辑

`graphService.ts`封装图形相关的API调用，包括图的增删改查、导入导出、MCP脚本生成等功能，处理请求数据的清洗和格式化。

```mermaid
sequenceDiagram
participant 组件 as UI组件
participant Service as graphService
participant API as api实例
participant 后端 as 后端API
组件->>Service : createGraph(graph)
Service->>Service : sanitizeForJson(graph)
Service->>Service : 清理和验证数据
Service->>API : post('/graphs', cleanedGraph)
API->>后端 : 发送HTTP请求
后端-->>API : 返回响应
API-->>Service : 解析响应
Service-->>组件 : 返回结果
```

**图示来源**  
- [graphService.ts](file://frontend/src/services/graphService.ts#L1-L223)
- [api.ts](file://frontend/src/services/api.ts#L1-L13)

## 实时事件流通信

### useSSEConnection实时通信

`useSSEConnection.ts`封装SSE（Server-Sent Events）连接，实现与后端的实时通信，支持消息推送和执行状态更新。

```mermaid
sequenceDiagram
participant 组件 as UI组件
participant Hook as useSSEConnection
participant 服务 as ConversationService
participant 后端 as 后端SSE端点
组件->>Hook : startConnection(inputText, options)
Hook->>Hook : 创建AbortController
Hook->>服务 : createChatSSE/createGraphSSE等
服务->>后端 : 建立SSE连接
loop 持续接收消息
后端->>服务 : 发送SSE消息
服务->>Hook : 返回ReadableStream
Hook->>Hook : processSSEData(消息)
Hook->>Hook : 更新streamingState
Hook->>组件 : 触发onMessage回调
end
组件->>Hook : closeConnection()
Hook->>Hook : abortController.abort()
Hook->>服务 : 取消流读取
```

**图示来源**  
- [useSSEConnection.ts](file://frontend/src/hooks/useSSEConnection.ts#L1-L522)
- [conversationService.ts](file://frontend/src/services/conversationService.ts)

## 前端架构图

综合展示UI组件、状态存储、服务接口之间的依赖关系。

```mermaid
graph TD
subgraph "UI层"
A[App.tsx]
B[MainLayout.tsx]
C[WorkspaceLayout.tsx]
D[GraphCanvas.tsx]
E[其他组件]
end
subgraph "状态层"
F[graphEditorStore]
G[mcpStore]
H[其他Store]
end
subgraph "服务层"
I[graphService]
J[mcpService]
K[其他Service]
L[api]
end
subgraph "通信层"
M[useSSEConnection]
end
A --> B
A --> C
C --> D
D --> F
B --> F
C --> F
D --> G
C --> G
F --> I
G --> J
I --> L
J --> L
M --> F
M --> G
M --> D
I --> M
J --> M
style F fill:#e6f7ff,stroke:#1677ff
style G fill:#e6f7ff,stroke:#1677ff
style L fill:#f9f0ff,stroke:#722ed1
style M fill:#fff7e6,stroke:#fa8c16
```

**图示来源**  
- [App.tsx](file://frontend/src/App.tsx#L1-L67)
- [layouts](file://frontend/src/layouts)
- [components](file://frontend/src/components)
- [store](file://frontend/src/store)
- [services](file://frontend/src/services)
- [hooks](file://frontend/src/hooks)